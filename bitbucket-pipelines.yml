image: atlassian/default-image:2

clone:
  depth: full

definitions:
  caches:
    gradle-wrapper: ~/.gradle/wrapper
    sonar: ~/.sonar/cache
  config:
    - &caches
      caches:
        - gradle
        - gradle-wrapper
        - sonar
  steps:
    - &check
      <<: *caches
      name: Check
      # language=sh
      script:
        - ./gradlew check sonar
    - &release
      <<: *caches
      name: Release
      # language=sh
      script:
        - git remote set-url origin "https://x-token-auth:$(curl -s -X POST -u "$BOT_CREDENTIALS" https://bitbucket.org/site/oauth2/access_token -d grant_type=client_credentials -d scopes="repository" | jq -r .access_token)@bitbucket.org/${BITBUCKET_REPO_OWNER}/${BITBUCKET_REPO_SLUG}"
        - ./gradlew release -Prelease.releaseVersion=$RELEASE_VERSION -Prelease.newVersion=$NEW_VERSION

pipelines:
  pull-requests:
    '**':
      - step: *check
  branches:
    master:
      - step: *release
  custom:
    release:
      - variables:
          - name: RELEASE_VERSION
          - name: NEW_VERSION
      - step: *release
